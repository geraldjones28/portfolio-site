# =============================================================================
# DOCKER COMPOSE — Portfolio Site
# Runs Nginx (static site) and a blog API (Node.js) for managing blog posts.
# The site/ directory is bind-mounted for Nginx; the blog-api service gets
# read-write access to site/blog/ only for creating/editing/deleting posts.
#
# Usage:
#   docker compose up -d --build   # Build and start all containers
#   docker compose down            # Stop and remove all containers
#   docker compose restart         # Restart after config changes
#   docker compose logs blog-api   # View blog API logs
# =============================================================================

#version: "3.9"
services:
  # --- Static Site Server ---
  web:
    image: nginx:alpine           # Lightweight Nginx image
    container_name: portfolio-web
    ports:
      - "8080:80"                 # Map host port 8080 to container port 80
                                  # (separate from other services like Juice Shop on :80)
    volumes:
      # Mount the site files into Nginx's document root (read-only)
      - ./site:/usr/share/nginx/html:ro
      # Mount the custom Nginx config (read-only)
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - blog-api                  # Ensure API is up before Nginx starts proxying
    restart: unless-stopped       # Auto-restart on crash or reboot (unless manually stopped)

  # --- Blog Management API ---
  # Node.js Express server that provides CRUD endpoints for blog posts.
  # Only has write access to the blog/ subdirectory (least privilege).
  # Not exposed to the host — only accessible via Nginx reverse proxy.
  blog-api:
    build: ./blog-api             # Build from blog-api/Dockerfile
    container_name: portfolio-blog-api
    volumes:
      - ./site/blog:/app/blog     # Read-write access to blog directory only
    environment:
      - BLOG_PASSWORD_HASH=${BLOG_PASSWORD_HASH}
      - JWT_SECRET=${JWT_SECRET}
    expose:
      - "3000"                    # Internal port only (not mapped to host)
    restart: unless-stopped
